<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Nudomy</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
	<script src="/js/jquery-3.4.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
  </head>
  <body class="container">
    <div id="navbar">
      <button
        class="btn btn-danger"
        href="/logout"
        onClick='document.location.href="/logout"'
      >
        Logout
      </button>
    </div>

    <div class="greetings">
      <h1>Hello <%= name %></h1>
    </div>
    <div class="col-md-6 col-md-offset-3">
      <button class="btn btn-success" id="show-metrics">Show some metrics</button>

    </div>
    <div id="metrics"></div>
    <script type="text/javascript">
      $('#show-metrics').click((e) => {
        e.preventDefault();
        $.getJSON("/metrics", {}, (data) => {
          /*
          const content = data.map(d => {
            return 'timestamp: ' + d.timestamp + ', value: ' + d.value + '';
          });
          $('#metrics').append(content.join("\n"));
          */
          console.log(data);
        });
        $.ajax({
          url: '/metrics',
          type: 'GET',
          success: (data, textStatus, xhr) => {
            //console.log("hey");
            //console.log(data);
            // Object.keys(data).forEach((el)=> {
            //   data[el].map((val, index) => {console.log(val);});
            // });
////// ugly tables
            // Object.keys(data).forEach((el)=> {
            //   let displays ='<table style="text-align: center;">';
            //
            //   console.log(data[el]);
            //   Object.keys(data[el]).forEach((pair)=> {
            //     displays += "<tr>";
            //     displays += "<td>";
            //     displays += " " + data[el][pair].timestamp +"</td><td>   value : "+ data[el][pair].value;
            //     displays += "</td>";
            //     displays += "</tr>";
            //   });
            //   displays += "</table><br><br><br>";
            //   $('#metrics').append(displays);
            // });
/////
            Object.keys(data).forEach((el)=> {
              let displays ='<canvas id="myChart_'+ el+ '" width="450" height="400"></canvas>';
              $('#metrics').append(displays);
              let values_array = [];
              let timestamps_array = [];


              Object.keys(data[el]).forEach((pair)=> {
                timestamps_array.push(data[el][pair].timestamp);
                values_array.push(data[el][pair].value);
              });

              var ctx = document.getElementById('myChart_'+el).getContext('2d');
              var linechart = new Chart(ctx, {
                type:'line',
                data: {
                  labels: timestamps_array,
                  datasets: [{
                     data: values_array,
                     label: 'random value',
                     backgroundColor: [
                        'rgba(255, 99, 30, 0.7)'
                      ]
                   }]
                },
                options: {
                  scales: {
                      yAxes: [{
                          ticks: {
                              beginAtZero: true
                          }
                      }]
                  }
                }
              });

            });

          },
        });
      });
    </script>
  </body>
</html>
